

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="chenli">
  <meta name="keywords" content="">
  
    <meta name="description" content="背景介绍Gym Trading EnvGym Trading Env is a Gymnasium environment for simulating stocks and training Reinforcement Learning (RL) trading agents. It was designed to be fast and customizable for easy RL tra">
<meta property="og:type" content="article">
<meta property="og:title" content="填坑——强化学习——使用智能体来预测股票">
<meta property="og:url" content="https://chenlidbk.xyz/2024/05/17/tiankeng10/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="背景介绍Gym Trading EnvGym Trading Env is a Gymnasium environment for simulating stocks and training Reinforcement Learning (RL) trading agents. It was designed to be fast and customizable for easy RL tra">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-05-17T03:27:00.000Z">
<meta property="article:modified_time" content="2024-06-03T04:10:00.128Z">
<meta property="article:author" content="chenli">
<meta property="article:tag" content="填坑">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>填坑——强化学习——使用智能体来预测股票 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"chenlidbk.xyz","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  



  
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>chenli</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="填坑——强化学习——使用智能体来预测股票"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-05-17 11:27" pubdate>
          2024年5月17日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          3.3k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          28 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">填坑——强化学习——使用智能体来预测股票</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p><a target="_blank" rel="noopener" href="https://gym-trading-env.readthedocs.io/en/latest/">Gym Trading Env</a>Gym Trading Env is a Gymnasium environment for simulating stocks and training Reinforcement Learning (RL) trading agents. It was designed to be fast and customizable for easy RL trading algorithms implementation.<br><a target="_blank" rel="noopener" href="https://github.com/wangshub/RL-Stock">如何用深度强化学习自动炒股</a><br><a target="_blank" rel="noopener" href="https://github.com/Jack-Cherish/quantitative?tab=readme-ov-file">量化交易</a><br><a target="_blank" rel="noopener" href="https://github.com/waditu/czsc">czsc</a></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>获取股票数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">import</span> baostock <span class="hljs-keyword">as</span> bs<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mkdir</span>(<span class="hljs-params">directory</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(directory):<br>        os.makedirs(directory)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Downloader</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,</span><br><span class="hljs-params">                 output_dir,</span><br><span class="hljs-params">                 date_start=<span class="hljs-string">&#x27;1990-01-01&#x27;</span>,</span><br><span class="hljs-params">                 date_end=<span class="hljs-string">&#x27;2024-03-16&#x27;</span></span>):<br>        self._bs = bs<br>        bs.login()<br>        self.date_start = date_start<br>        <span class="hljs-comment"># self.date_end = datetime.datetime.now().strftime(&quot;%Y-%m-%d&quot;)</span><br>        self.date_end = date_end<br>        self.output_dir = output_dir<br>        self.fields = <span class="hljs-string">&quot;date,open,high,low,close,amount,volume&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>(<span class="hljs-params">self</span>):<br>        bs.logout()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_codes_by_date</span>(<span class="hljs-params">self, date</span>):<br>        <span class="hljs-built_in">print</span>(date)<br>        stock_rs = bs.query_all_stock(date)<br>        stock_df = stock_rs.get_data()<br>        <span class="hljs-built_in">print</span>(stock_df)<br>        <span class="hljs-keyword">return</span> stock_df<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        stock_df = self.get_codes_by_date(self.date_end)<br>        <span class="hljs-keyword">for</span> index, row <span class="hljs-keyword">in</span> stock_df.iterrows():<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;processing <span class="hljs-subst">&#123;row[<span class="hljs-string">&quot;code&quot;</span>]&#125;</span> <span class="hljs-subst">&#123;row[<span class="hljs-string">&quot;code_name&quot;</span>]&#125;</span>&#x27;</span>)<br>            df_code = bs.query_history_k_data_plus(row[<span class="hljs-string">&quot;code&quot;</span>], self.fields,<br>                                               start_date=self.date_start,<br>                                               end_date=self.date_end).get_data()<br>        <span class="hljs-comment"># 替换文件名中的*字符为_</span><br>            code_name = row[<span class="hljs-string">&quot;code_name&quot;</span>].replace(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-string">&#x27;_&#x27;</span>)<br>            df_code.to_csv(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;self.output_dir&#125;</span>/<span class="hljs-subst">&#123;row[<span class="hljs-string">&quot;code&quot;</span>]&#125;</span>.<span class="hljs-subst">&#123;code_name&#125;</span>.csv&#x27;</span>, index=<span class="hljs-literal">False</span>)<br>        self.exit()<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># 获取全部股票的日K线数据</span><br>    mkdir(<span class="hljs-string">&#x27;./data/train&#x27;</span>)<br>    downloader = Downloader(<span class="hljs-string">&#x27;./data/train&#x27;</span>, date_start=<span class="hljs-string">&#x27;2000-01-01&#x27;</span>, date_end=<span class="hljs-string">&#x27;2024-2-29&#x27;</span>)<br>    downloader.run()<br><br>    mkdir(<span class="hljs-string">&#x27;./data/test&#x27;</span>)<br>    downloader = Downloader(<span class="hljs-string">&#x27;./data/test&#x27;</span>, date_start=<span class="hljs-string">&#x27;2024-3-1&#x27;</span>, date_end=<span class="hljs-string">&#x27;2024-3-15&#x27;</span>)<br>    downloader.run()<br><br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://baostock.com/baostock/index.php/Python_API%E6%96%87%E6%A1%A3">Baostack的API文档</a></p>
<h2 id="选股器"><a href="#选股器" class="headerlink" title="选股器"></a>选股器</h2><p>思路，股票是波动的，但是波动是现象，可能今天是下跌，但是明天就上升了。</p>
<p>根据什么指标来构建筛选股票？，评价指标是什么?</p>
<h3 id="聚宽平台"><a href="#聚宽平台" class="headerlink" title="聚宽平台"></a>聚宽平台</h3><p><a target="_blank" rel="noopener" href="https://www.joinquant.com/help/api/help#name:aboutData">聚宽数据</a><br><a href="">新手指引</a><a target="_blank" rel="noopener" href="https://www.joinquant.com/view/community/detail/7e4989804f4d3cd12532cafefeea1bcb">https://www.joinquant.com/view/community/detail/7e4989804f4d3cd12532cafefeea1bcb</a><br>关于聚宽数据<br>股票数据：我们拥有所有A股上市公司2005年以来的股票行情数据、财务数据、上市公司基本信息、融资融券信息等。为了避免幸存者偏差，我们包括了已经退市的股票数据。其中volume（成交量）字段单位是股。<br>商品期货：我们支持从2005年以来上海国际能源交易中心、上期所、郑商所、大商所的行情数据，并包含历史产品的数据。<br>基金数据：我们目前提供了600多种在交易所上市的基金的行情、净值等数据，包含ETF、LOF、分级A&#x2F;B基金以及货币基金的完整的行情、净值数据等，请点击基金数据查看。<br>金融期货数据：我们提供中金所推出的所有金融期货产品的行情数据，并包含历史产品的数据。<br>股票指数：我们支持近600种指数数据，包括指数的行情数据以及成分股数据。为了避免未来函数，我们支持获取历史任意时刻的指数成分股信息，具体见get_index_stocks。<br>行业板块：我们支持按行业、按板块选股，具体见get_industry_stocks<br>概念板块：我们支持按概念板块选股，具体见get_concept_stocks<br>宏观数据：我们提供全方位的宏观数据，为投资者决策提供有力数据支持。</p>
<h3 id="本地化数据JQData"><a href="#本地化数据JQData" class="headerlink" title="本地化数据JQData"></a>本地化数据JQData</h3><p><a target="_blank" rel="noopener" href="https://www.joinquant.com/help/api/help#JQData:JQData">JQData</a><br>QData由聚宽团队专门维护清洗，为金融机构、学术团体和量化研究者们提供的本地量化金融数据服务。 数据产品不仅对外服务，同时服务于聚宽所有业务线，历经平台40万用户、基金百亿资产、每年万亿交易额的考验。本着推动量化行业快速发展的良好愿景，JQData现已开放注册。</p>
<p>安装本地数据JQData<code>pip install jqdatasdk</code></p>
<h3 id="代码解析工程"><a href="#代码解析工程" class="headerlink" title="代码解析工程"></a>代码解析工程</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">优化说明:</span><br><span class="hljs-string">    1.使用修正标准分</span><br><span class="hljs-string">        rsrs_score的算法有：</span><br><span class="hljs-string">            仅斜率slope，效果一般；</span><br><span class="hljs-string">            仅标准分zscore，效果不错；</span><br><span class="hljs-string">            修正标准分 = zscore * r2，效果最佳;</span><br><span class="hljs-string">            右偏标准分 = 修正标准分 * slope，效果不错。</span><br><span class="hljs-string">    2.将原策略的每次持有两只etf改成只买最优的一个，收益显著提高</span><br><span class="hljs-string">    3.将每周调仓换成每日调仓，收益显著提高</span><br><span class="hljs-string">    4.因为交易etf，所以手续费设为万分之三，印花税设为零，未设置滑点</span><br><span class="hljs-string">    5.修改股票池中候选etf，删除银行，红利等收益较弱品种，增加纳指etf以增加不同国家市场间轮动的可能性</span><br><span class="hljs-string">    6.根据研报，默认参数介已设定为最优</span><br><span class="hljs-string">    7.加入防未来函数</span><br><span class="hljs-string">    8.增加择时与选股模块的打印日志，方便观察每笔操作依据</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment">#导入函数库</span><br><span class="hljs-keyword">from</span> jqdata <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-comment">#初始化函数 </span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params">context</span>):<br>    <span class="hljs-comment"># 设定沪深300作为基准</span><br>    set_benchmark(<span class="hljs-string">&#x27;000300.XSHG&#x27;</span>)<br>    <span class="hljs-comment"># 用真实价格交易</span><br>    set_option(<span class="hljs-string">&#x27;use_real_price&#x27;</span>, <span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 打开防未来函数</span><br>    set_option(<span class="hljs-string">&quot;avoid_future_data&quot;</span>, <span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 将滑点设置为0</span><br>    set_slippage(FixedSlippage(<span class="hljs-number">0.001</span>))<br>    <span class="hljs-comment"># 设置交易成本万分之三</span><br>    set_order_cost(OrderCost(open_tax=<span class="hljs-number">0</span>, close_tax=<span class="hljs-number">0</span>, open_commission=<span class="hljs-number">0.0003</span>, close_commission=<span class="hljs-number">0.0003</span>, close_today_commission=<span class="hljs-number">0</span>, min_commission=<span class="hljs-number">5</span>),<br>                   <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;fund&#x27;</span>)<br>    <span class="hljs-comment"># 股票类每笔交易时的手续费是：买入时佣金万分之二，卖出时佣金万分之二，无印花税, 每笔交易佣金最低扣5块钱</span><br>    <span class="hljs-comment"># set_order_cost(OrderCost(close_tax=0.000, open_commission=0.0002, close_commission=0.0002, min_commission=5), type=&#x27;fund&#x27;)</span><br>    <span class="hljs-comment"># 过滤order中低于error级别的日志</span><br>    log.set_level(<span class="hljs-string">&#x27;order&#x27;</span>, <span class="hljs-string">&#x27;error&#x27;</span>)<br>    <span class="hljs-comment"># 初始化各类全局变量</span><br>    <span class="hljs-comment">#股票池</span><br>    g.stock_pool = [<br>        <span class="hljs-string">&#x27;159915.XSHE&#x27;</span>, <span class="hljs-comment"># 易方达创业板ETF</span><br>        <span class="hljs-string">&#x27;510300.XSHG&#x27;</span>, <span class="hljs-comment"># 华泰柏瑞沪深300ETF</span><br>        <span class="hljs-string">&#x27;510500.XSHG&#x27;</span>, <span class="hljs-comment"># 南方中证500ETF</span><br>    ]<br>    <span class="hljs-comment">#动量轮动参数</span><br>    g.stock_num = <span class="hljs-number">1</span> <span class="hljs-comment">#买入评分最高的前stock_num只股票</span><br>    g.momentum_day = <span class="hljs-number">29</span> <span class="hljs-comment">#最新动量参考最近momentum_day的</span><br>    <span class="hljs-comment">#rsrs择时参数</span><br>    g.ref_stock = <span class="hljs-string">&#x27;000300.XSHG&#x27;</span> <span class="hljs-comment">#用ref_stock做择时计算的基础数据</span><br>    g.N = <span class="hljs-number">18</span> <span class="hljs-comment"># 计算最新斜率slope，拟合度r2参考最近N天</span><br>    g.M = <span class="hljs-number">600</span> <span class="hljs-comment"># 计算最新标准分zscore，rsrs_score参考最近M天</span><br>    g.score_threshold = <span class="hljs-number">0.7</span> <span class="hljs-comment"># rsrs标准分指标阈值</span><br>    <span class="hljs-comment">#ma择时参数</span><br>    g.mean_day = <span class="hljs-number">20</span> <span class="hljs-comment">#计算结束ma收盘价，参考最近mean_day</span><br>    g.mean_diff_day = <span class="hljs-number">3</span> <span class="hljs-comment">#计算初始ma收盘价，参考(mean_day + mean_diff_day)天前，窗口为mean_diff_day的一段时间</span><br>    g.slope_series = initial_slope_series()[:-<span class="hljs-number">1</span>] <span class="hljs-comment"># 除去回测第一天的slope，避免运行时重复加入</span><br>    <span class="hljs-comment"># 设置交易时间，每天运行</span><br>    run_daily(my_trade, time=<span class="hljs-string">&#x27;11:30&#x27;</span>, reference_security=<span class="hljs-string">&#x27;000300.XSHG&#x27;</span>)<br>    run_daily(check_lose, time=<span class="hljs-string">&#x27;open&#x27;</span>, reference_security=<span class="hljs-string">&#x27;000300.XSHG&#x27;</span>)<br>    run_daily(print_trade_info, time=<span class="hljs-string">&#x27;15:30&#x27;</span>, reference_security=<span class="hljs-string">&#x27;000300.XSHG&#x27;</span>)<br><br><br><span class="hljs-comment">#1-1 选股模块-动量因子轮动 </span><br><span class="hljs-comment">#基于股票年化收益和判定系数打分,并按照分数从大到小排名</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_rank</span>(<span class="hljs-params">stock_pool</span>):<br>    score_list = []<br>    <span class="hljs-keyword">for</span> stock <span class="hljs-keyword">in</span> g.stock_pool:<br>        data = attribute_history(stock, g.momentum_day, <span class="hljs-string">&#x27;1d&#x27;</span>, [<span class="hljs-string">&#x27;close&#x27;</span>])<br>        y = data[<span class="hljs-string">&#x27;log&#x27;</span>] = np.log(data.close)<br>        x = data[<span class="hljs-string">&#x27;num&#x27;</span>] = np.arange(data.log.size)<br>        slope, intercept = np.polyfit(x, y, <span class="hljs-number">1</span>)<br>        annualized_returns = math.<span class="hljs-built_in">pow</span>(math.exp(slope), <span class="hljs-number">250</span>) - <span class="hljs-number">1</span><br>        r_squared = <span class="hljs-number">1</span> - (<span class="hljs-built_in">sum</span>((y - (slope * x + intercept))**<span class="hljs-number">2</span>) / ((<span class="hljs-built_in">len</span>(y) - <span class="hljs-number">1</span>) * np.var(y, ddof=<span class="hljs-number">1</span>)))<br>        score = annualized_returns * r_squared<br>        score_list.append(score)<br>    stock_dict=<span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(g.stock_pool, score_list))<br>    sort_list=<span class="hljs-built_in">sorted</span>(stock_dict.items(), key=<span class="hljs-keyword">lambda</span> item:item[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>) <span class="hljs-comment">#True为降序</span><br>    code_list=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>((<span class="hljs-built_in">len</span>(g.stock_pool))):<br>        code_list.append(sort_list[i][<span class="hljs-number">0</span>])<br>    rank_stock = code_list[<span class="hljs-number">0</span>:g.stock_num]<br>    <span class="hljs-built_in">print</span>(code_list[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>])<br>    <span class="hljs-keyword">return</span> rank_stock<br><br><br><br><span class="hljs-comment">#2-1 择时模块-计算线性回归统计值</span><br><span class="hljs-comment">#对输入的自变量每日最低价x(series)和因变量每日最高价y(series)建立OLS回归模型,返回元组(截距,斜率,拟合度)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_ols</span>(<span class="hljs-params">x, y</span>):<br>    slope, intercept = np.polyfit(x, y, <span class="hljs-number">1</span>)<br>    r2 = <span class="hljs-number">1</span> - (<span class="hljs-built_in">sum</span>((y - (slope * x + intercept))**<span class="hljs-number">2</span>) / ((<span class="hljs-built_in">len</span>(y) - <span class="hljs-number">1</span>) * np.var(y, ddof=<span class="hljs-number">1</span>)))<br>    <span class="hljs-keyword">return</span> (intercept, slope, r2)<br><br><span class="hljs-comment">#2-2 择时模块-设定初始斜率序列</span><br><span class="hljs-comment">#通过前M日最高最低价的线性回归计算初始的斜率,返回斜率的列表</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">initial_slope_series</span>():<br>    data = attribute_history(g.ref_stock, g.N + g.M, <span class="hljs-string">&#x27;1d&#x27;</span>, [<span class="hljs-string">&#x27;high&#x27;</span>, <span class="hljs-string">&#x27;low&#x27;</span>])<br>    <span class="hljs-keyword">return</span> [get_ols(data.low[i:i+g.N], data.high[i:i+g.N])[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(g.M)]<br><br><span class="hljs-comment">#2-3 择时模块-计算标准分</span><br><span class="hljs-comment">#通过斜率列表计算并返回截至回测结束日的最新标准分</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_zscore</span>(<span class="hljs-params">slope_series</span>):<br>    mean = np.mean(slope_series)<br>    std = np.std(slope_series)<br>    <span class="hljs-keyword">return</span> (slope_series[-<span class="hljs-number">1</span>] - mean) / std<br><br><span class="hljs-comment">#2-4 择时模块-计算综合信号</span><br><span class="hljs-comment">#1.获得rsrs与MA信号,rsrs信号算法参考优化说明，MA信号为一段时间两个端点的MA数值比较大小</span><br><span class="hljs-comment">#2.信号同时为True时返回买入信号，同为False时返回卖出信号，其余情况返回持仓不变信号</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_timing_signal</span>(<span class="hljs-params">stock</span>):<br>    <span class="hljs-comment">#计算MA信号</span><br>    close_data = attribute_history(g.ref_stock, g.mean_day + g.mean_diff_day, <span class="hljs-string">&#x27;1d&#x27;</span>, [<span class="hljs-string">&#x27;close&#x27;</span>])<br>    today_MA = close_data.close[g.mean_diff_day:].mean() <br>    before_MA = close_data.close[:-g.mean_diff_day].mean()<br>    <span class="hljs-comment">#计算rsrs信号</span><br>    high_low_data = attribute_history(g.ref_stock, g.N, <span class="hljs-string">&#x27;1d&#x27;</span>, [<span class="hljs-string">&#x27;high&#x27;</span>, <span class="hljs-string">&#x27;low&#x27;</span>])<br>    intercept, slope, r2 = get_ols(high_low_data.low, high_low_data.high)<br>    g.slope_series.append(slope)<br>    rsrs_score = get_zscore(g.slope_series[-g.M:]) * r2<br>    <span class="hljs-comment">#综合判断所有信号</span><br>    <span class="hljs-keyword">if</span> rsrs_score &gt; g.score_threshold <span class="hljs-keyword">and</span> today_MA &gt; before_MA:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;BUY&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;BUY&quot;</span><br>    <span class="hljs-keyword">elif</span> rsrs_score &lt; -g.score_threshold <span class="hljs-keyword">and</span> today_MA &lt; before_MA:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;SELL&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SELL&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;KEEP&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;KEEP&quot;</span><br><br><br><span class="hljs-comment">#3-1 过滤模块-过滤停牌股票</span><br><span class="hljs-comment">#输入选股列表，返回剔除停牌股票后的列表</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_paused_stock</span>(<span class="hljs-params">stock_list</span>):<br>	current_data = get_current_data()<br>	<span class="hljs-keyword">return</span> [stock <span class="hljs-keyword">for</span> stock <span class="hljs-keyword">in</span> stock_list <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> current_data[stock].paused]<br><br><span class="hljs-comment">#3-2 过滤模块-过滤ST及其他具有退市标签的股票</span><br><span class="hljs-comment">#输入选股列表，返回剔除ST及其他具有退市标签股票后的列表</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_st_stock</span>(<span class="hljs-params">stock_list</span>):<br>	current_data = get_current_data()<br>	<span class="hljs-keyword">return</span> [stock <span class="hljs-keyword">for</span> stock <span class="hljs-keyword">in</span> stock_list<br>			<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> current_data[stock].is_st<br>			<span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;ST&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> current_data[stock].name<br>			<span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;*&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> current_data[stock].name<br>			<span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;退&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> current_data[stock].name]<br><br><span class="hljs-comment">#3-3 过滤模块-过滤涨停的股票</span><br><span class="hljs-comment">#输入选股列表，返回剔除未持有且已涨停股票后的列表</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_limitup_stock</span>(<span class="hljs-params">context, stock_list</span>):<br>	last_prices = history(<span class="hljs-number">1</span>, unit=<span class="hljs-string">&#x27;1m&#x27;</span>, field=<span class="hljs-string">&#x27;close&#x27;</span>, security_list=stock_list)<br>	current_data = get_current_data()<br>	<span class="hljs-comment"># 已存在于持仓的股票即使涨停也不过滤，避免此股票再次可买，但因被过滤而导致选择别的股票</span><br>	<span class="hljs-keyword">return</span> [stock <span class="hljs-keyword">for</span> stock <span class="hljs-keyword">in</span> stock_list <span class="hljs-keyword">if</span> stock <span class="hljs-keyword">in</span> context.portfolio.positions.keys()<br>			<span class="hljs-keyword">or</span> last_prices[stock][-<span class="hljs-number">1</span>] &lt; current_data[stock].high_limit]<br><br><span class="hljs-comment">#3-4 过滤模块-过滤跌停的股票</span><br><span class="hljs-comment">#输入股票列表，返回剔除已跌停股票后的列表</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_limitdown_stock</span>(<span class="hljs-params">context, stock_list</span>):<br>	last_prices = history(<span class="hljs-number">1</span>, unit=<span class="hljs-string">&#x27;1m&#x27;</span>, field=<span class="hljs-string">&#x27;close&#x27;</span>, security_list=stock_list)<br>	current_data = get_current_data()<br>	<span class="hljs-keyword">return</span> [stock <span class="hljs-keyword">for</span> stock <span class="hljs-keyword">in</span> stock_list <span class="hljs-keyword">if</span> stock <span class="hljs-keyword">in</span> context.portfolio.positions.keys()<br>			<span class="hljs-keyword">or</span> last_prices[stock][-<span class="hljs-number">1</span>] &gt; current_data[stock].low_limit]<br><br><br><br><span class="hljs-comment">#4-1 交易模块-自定义下单</span><br><span class="hljs-comment">#报单成功返回报单(不代表一定会成交),否则返回None,应用于</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">order_target_value_</span>(<span class="hljs-params">security, value</span>):<br>	<span class="hljs-keyword">if</span> value == <span class="hljs-number">0</span>:<br>		log.debug(<span class="hljs-string">&quot;Selling out %s&quot;</span> % (security))<br>	<span class="hljs-keyword">else</span>:<br>		log.debug(<span class="hljs-string">&quot;Order %s to value %f&quot;</span> % (security, value))<br>	<span class="hljs-comment"># 如果股票停牌，创建报单会失败，order_target_value 返回None</span><br>	<span class="hljs-comment"># 如果股票涨跌停，创建报单会成功，order_target_value 返回Order，但是报单会取消</span><br>	<span class="hljs-comment"># 部成部撤的报单，聚宽状态是已撤，此时成交量&gt;0，可通过成交量判断是否有成交</span><br>	<span class="hljs-keyword">return</span> order_target_value(security, value)<br><br><span class="hljs-comment">#4-2 交易模块-开仓</span><br><span class="hljs-comment">#买入指定价值的证券,报单成功并成交(包括全部成交或部分成交,此时成交量大于0)返回True,报单失败或者报单成功但被取消(此时成交量等于0),返回False</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">open_position</span>(<span class="hljs-params">security, value</span>):<br>	order = order_target_value_(security, value)<br>	<span class="hljs-keyword">if</span> order != <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> order.filled &gt; <span class="hljs-number">0</span>:<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-comment">#4-3 交易模块-平仓</span><br><span class="hljs-comment">#卖出指定持仓,报单成功并全部成交返回True，报单失败或者报单成功但被取消(此时成交量等于0),或者报单非全部成交,返回False</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">close_position</span>(<span class="hljs-params">position</span>):<br>	security = position.security<br>	order = order_target_value_(security, <span class="hljs-number">0</span>)  <span class="hljs-comment"># 可能会因停牌失败</span><br>	<span class="hljs-keyword">if</span> order != <span class="hljs-literal">None</span>:<br>		<span class="hljs-keyword">if</span> order.status == OrderStatus.held <span class="hljs-keyword">and</span> order.filled == order.amount:<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-comment">#4-4 交易模块-调仓</span><br><span class="hljs-comment">#当择时信号为买入时开始调仓，输入过滤模块处理后的股票列表，执行交易模块中的开平仓操作</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_position</span>(<span class="hljs-params">context, buy_stocks</span>):<br>	<span class="hljs-keyword">for</span> stock <span class="hljs-keyword">in</span> context.portfolio.positions:<br>		<span class="hljs-keyword">if</span> stock <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> buy_stocks:<br>			log.info(<span class="hljs-string">&quot;[%s]已不在应买入列表中&quot;</span> % (stock))<br>			position = context.portfolio.positions[stock]<br>			close_position(position)<br>		<span class="hljs-keyword">else</span>:<br>			log.info(<span class="hljs-string">&quot;[%s]已经持有无需重复买入&quot;</span> % (stock))<br>	<span class="hljs-comment"># 根据股票数量分仓</span><br>	<span class="hljs-comment"># 此处只根据可用金额平均分配购买，不能保证每个仓位平均分配</span><br>	position_count = <span class="hljs-built_in">len</span>(context.portfolio.positions)<br>	<span class="hljs-keyword">if</span> g.stock_num &gt; position_count:<br>		value = context.portfolio.cash / (g.stock_num - position_count)<br>		<span class="hljs-keyword">for</span> stock <span class="hljs-keyword">in</span> buy_stocks:<br>			<span class="hljs-keyword">if</span> context.portfolio.positions[stock].total_amount == <span class="hljs-number">0</span>:<br>				<span class="hljs-keyword">if</span> open_position(stock, value):<br>					<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(context.portfolio.positions) == g.stock_num:<br>						<span class="hljs-keyword">break</span><br><br><span class="hljs-comment">#4-5 交易模块-择时交易</span><br><span class="hljs-comment">#结合择时模块综合信号进行交易</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_trade</span>(<span class="hljs-params">context</span>):<br>    <span class="hljs-comment">#获取选股列表并过滤掉:st,st*,退市,涨停,跌停,停牌</span><br>    check_out_list = get_rank(g.stock_pool)<br>    check_out_list = filter_st_stock(check_out_list)<br>    check_out_list = filter_limitup_stock(context, check_out_list)<br>    check_out_list = filter_limitdown_stock(context, check_out_list)<br>    check_out_list = filter_paused_stock(check_out_list)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;今日自选股:&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(check_out_list))<br>    <span class="hljs-comment">#获取综合择时信号</span><br>    timing_signal = get_timing_signal(g.ref_stock)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;今日择时信号:&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(timing_signal))<br>    <span class="hljs-comment">#开始交易</span><br>    <span class="hljs-keyword">if</span> timing_signal == <span class="hljs-string">&#x27;SELL&#x27;</span>:<br>        <span class="hljs-keyword">for</span> stock <span class="hljs-keyword">in</span> context.portfolio.positions:<br>            position = context.portfolio.positions[stock]<br>            close_position(position)<br>    <span class="hljs-keyword">elif</span> timing_signal == <span class="hljs-string">&#x27;BUY&#x27;</span> <span class="hljs-keyword">or</span> timing_signal == <span class="hljs-string">&#x27;KEEP&#x27;</span>:<br>        adjust_position(context, check_out_list)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">pass</span><br><br><span class="hljs-comment">#4-6 交易模块-止损</span><br><span class="hljs-comment">#检查持仓并进行必要的止损操作</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_lose</span>(<span class="hljs-params">context</span>):<br>    <span class="hljs-keyword">for</span> position <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>(context.portfolio.positions.values()):<br>        securities=position.security<br>        cost=position.avg_cost<br>        price=position.price<br>        ret=<span class="hljs-number">100</span>*(price/cost-<span class="hljs-number">1</span>)<br>        value=position.value<br>        amount=position.total_amount<br>        <span class="hljs-comment">#这里设定80%止损几乎等同不止损，因为止损在指数etf策略中影响不大</span><br>        <span class="hljs-keyword">if</span> ret &lt;=-<span class="hljs-number">20</span>:<br>            order_target_value(position.security, <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;！！！！！！触发止损信号: 标的=&#123;&#125;,标的价值=&#123;&#125;,浮动盈亏=&#123;&#125;% ！！！！！！&quot;</span><br>                .<span class="hljs-built_in">format</span>(securities,<span class="hljs-built_in">format</span>(value,<span class="hljs-string">&#x27;.2f&#x27;</span>),<span class="hljs-built_in">format</span>(ret,<span class="hljs-string">&#x27;.2f&#x27;</span>)))<br><br><span class="hljs-comment">#5-1 复盘模块-打印</span><br><span class="hljs-comment">#打印每日持仓信息</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">print_trade_info</span>(<span class="hljs-params">context</span>):<br>    <span class="hljs-comment">#打印当天成交记录</span><br>    trades = get_trades()<br>    <span class="hljs-keyword">for</span> _trade <span class="hljs-keyword">in</span> trades.values():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;成交记录：&#x27;</span>+<span class="hljs-built_in">str</span>(_trade))<br>    <span class="hljs-comment">#打印账户信息</span><br>    <span class="hljs-keyword">for</span> position <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>(context.portfolio.positions.values()):<br>        securities=position.security<br>        cost=position.avg_cost<br>        price=position.price<br>        ret=<span class="hljs-number">100</span>*(price/cost-<span class="hljs-number">1</span>)<br>        value=position.value<br>        amount=position.total_amount    <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;代码:&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(securities))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;成本价:&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">format</span>(cost,<span class="hljs-string">&#x27;.2f&#x27;</span>)))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;现价:&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(price))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;收益率:&#123;&#125;%&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">format</span>(ret,<span class="hljs-string">&#x27;.2f&#x27;</span>)))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;持仓(股):&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(amount))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;市值:&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">format</span>(value,<span class="hljs-string">&#x27;.2f&#x27;</span>)))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;一天结束&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;———————————————————————————————————————分割线————————————————————————————————————————&#x27;</span>)<br><br><br></code></pre></td></tr></table></figure>

























<h2 id="推荐书籍"><a href="#推荐书籍" class="headerlink" title="推荐书籍"></a>推荐书籍</h2><p><a target="_blank" rel="noopener" href="https://weread.qq.com/web/reader/1b5325907159cacc1b5e0e1">股票大作手回忆录</a></p>
<h2 id="个人感悟"><a href="#个人感悟" class="headerlink" title="个人感悟"></a>个人感悟</h2><p>炒股就是和自己修炼的过程，在整个过程中需要对抗自己的贪，疑，痴，慢。是使用一个自己来战胜另一个自己的过程。时机，多层次的关系。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%A1%AB%E5%9D%91/" class="print-no-link">#填坑</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>填坑——强化学习——使用智能体来预测股票</div>
      <div>https://chenlidbk.xyz/2024/05/17/tiankeng10/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>chenli</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年5月17日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/05/18/gaodengshuxue5/" title="高等数学——常微分方程">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">高等数学——常微分方程</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/05/16/tiankeng9/" title="填坑-AIGC和数字化新时代">
                        <span class="hidden-mobile">填坑-AIGC和数字化新时代</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/changjingzhi/Blog/tree/main" target="_blank" rel="nofollow noopener"><span>联系方式</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
